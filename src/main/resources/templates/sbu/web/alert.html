<html xmlns:th="http://www.thymeleaf.org">

<div th:fragment="bs5" th:with="alert=${__${@webModelAttributes.ALERT_NAME}__}"
  class="sbu-alert-container">

  <th:block th:if="${alert}">

    <th:block th:each="message : ${alert.danger}">
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <span th:if="${#messages.msgOrNull(message) != null}"
          th:utext="${#messages.msgOrNull(message)}"></span>
        <th:block th:unless="${#messages.msgOrNull(message) != null}">
          <span th:unless="${alert.utext}">[[${message}]]</span>
          <span th:if="${alert.utext}" th:utext="${message}"></span>
        </th:block>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    </th:block>

    <th:block th:each="message : ${alert.warning}">
      <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <span th:if="${#messages.msgOrNull(message) != null}"
          th:utext="${#messages.msgOrNull(message)}"></span>
        <th:block th:unless="${#messages.msgOrNull(message) != null}">
          <span th:unless="${alert.utext}">[[${message}]]</span>
          <span th:if="${alert.utext}" th:utext="${message}"></span>
        </th:block>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    </th:block>

    <th:block th:each="message : ${alert.info}">
      <div class="alert alert-info alert-dismissible fade show" role="alert">
        <span th:if="${#messages.msgOrNull(message) != null}"
          th:utext="${#messages.msgOrNull(message)}"></span>
        <th:block th:unless="${#messages.msgOrNull(message) != null}">
          <span th:unless="${alert.utext}">[[${message}]]</span>
          <span th:if="${alert.utext}" th:utext="${message}"></span>
        </th:block>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    </th:block>

    <th:block th:each="message : ${alert.success}">
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <span th:if="${#messages.msgOrNull(message) != null}"
          th:utext="${#messages.msgOrNull(message)}"></span>
        <th:block th:unless="${#messages.msgOrNull(message) != null}">
          <span th:unless="${alert.utext}">[[${message}]]</span>
          <span th:if="${alert.utext}" th:utext="${message}"></span>
        </th:block>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    </th:block>

  </th:block>

  <script th:if="${alert}">
    (function () {
      // Consolidate alerts to first container only
      function consolidateAlerts() {
        const containers = document.querySelectorAll('.sbu-alert-container');
        if (containers.length <= 1) return;

        // Find first container with alerts
        let firstContainer = null;
        let alertsToMove = [];

        containers.forEach((container, index) => {
          const alerts = container.querySelectorAll('.alert');
          if (alerts.length > 0) {
            if (!firstContainer) {
              firstContainer = container;
            } else {
              // Collect alerts from other containers
              alerts.forEach(alert => {
                alertsToMove.push(alert.cloneNode(true));
                alert.remove();
              });
            }
          }
        });

        // Move collected alerts to first container
        if (firstContainer && alertsToMove.length > 0) {
          alertsToMove.forEach(alert => {
            // Check if identical alert doesn't already exist
            const existingAlerts = firstContainer.querySelectorAll('.alert');
            let isDuplicate = false;
            existingAlerts.forEach(existing => {
              if (existing.textContent.trim() === alert.textContent.trim()) {
                isDuplicate = true;
              }
            });
            if (!isDuplicate) {
              firstContainer.appendChild(alert);
            }
          });
        }
      }

      // Run on DOM ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', consolidateAlerts);
      } else {
        consolidateAlerts();
      }

      // Also run after HTMX requests if HTMX is present
      if (typeof htmx !== 'undefined') {
        document.body.addEventListener('htmx:afterSwap', function () {
          setTimeout(consolidateAlerts, 10);
        });
        document.body.addEventListener('htmx:afterSettle', consolidateAlerts);
      }
    })();
  </script>

</div>

</html>